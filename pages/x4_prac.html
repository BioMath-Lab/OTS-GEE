<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="../scripts/style.css" />
<script src="../scripts/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script src="../scripts/clipboard.min.js"></script>
<title>Google Earth Engine for Ecology and Conservation</title>
</head>

<body>

<div id="wrap">
<div id="header">
<h1>GOOGLE EARTH ENGINE APPLICATIONS</h1>
<h1>IN ECOLOGY AND CONSERVATION</h1>
</div>

<div id="content">
<h2>GOOGLE EARTH ENGINE FOR ECOLOGY AND CONSERVATION</h2>
<p><strong>Practical 4: Long-term patterns of rainfall in and around Awast National Park in Ethiopia</strong>
<br>by Sandra MacFadyen @ <a href="https://www0.sun.ac.za/biomath/">https://www0.sun.ac.za/biomath</a>
<br>Access the completed practical script <a href="https://code.earthengine.google.com/?scriptPath=users%2Fjdmwhite%2FOTS-GEE4EC%3APractical_1%2FExploring_images">here</a>.
<br><br>
<strong>Learning Objectives</strong><br>
By the end of this practical you should be able to:
<ol><li>Access long-term rainfall data</li>
<li>Summarise temporal data by region</li>
<li>Display results on a map and in time-series plots</li>
<li>Make an interactive map (GEE App)</li>
<li>Compare rainfall and vegetation 'greenness" (i.e. rainfall as a driver of ecosystem processes like vegetation dynamics)</li>
<li>Output data (csv, rasterStack) for analysis outside of GEE</li></ol>
<p><img src="img/4_img1.png" width="650" alt="" title="" />
<hr>

<p><strong>Introduction</strong>
<br>Rainfall plays a central role in a myriad of natural processes, including river health, the transportation of nutrients, soil moisture, vegetation dynamics,
  fire regimes, animal movement and distribution patterns and landscape heterogeneity.
  Within protected areas these processes function together to safeguard ecosystem integrity. In the face of current climate change predictions,
  the spatio-temporal patterns of rainfall is an increasingly important component to include in any ecological study (MacFadyen et al 2018).
  Here we explore patterns of monthly rainfall across Costa Rica and the Braulio Carrillo National Park from 1981 to 2019 (39 years).
  We'll summarise monthly and annual rainfall patterns using line charts and examine the long-term spatial patterns of rainfall using an interactive map.
  Lastly, we'll take a look at how the temporal patterns of annual rainfall compares to those of vegetation vigour or 'greenness',
  highlighting its importance as a bottom-up ecosystem driver.</p>
<hr>

<p><strong>Importing datasets</strong>
<br>The datasets we will use for this practical are all available on Google Earth Engine and can be accessed as follows (You can convert these to an import record,
using `convert` from the pop-up message):</p>

<pre><p><code class="javascript" id="target1">var Countries = ee.FeatureCollection('USDOS/LSIB/2017');
var WDPA = ee.FeatureCollection('WCMC/WDPA/current/polygons');
var CHIRPS = ee.ImageCollection('UCSB-CHG/CHIRPS/PENTAD');
var MOD13Q1 = ee.ImageCollection('MODIS/006/MOD13Q1');</code><button class="btn" id="copy-button" data-clipboard-target="#target1">Copy</button>
<script>new ClipboardJS('.btn');</script></pre>

<p>The first dataset, <a href="https://developers.google.com/earth-engine/datasets/catalog/WCMC_WDPA_current_polygons" target="_blank">LSIB 2017</a>, contains polygon representations of all international boundaries.
The second, <a href="https://developers.google.com/earth-engine/datasets/catalog/WCMC_WDPA_current_polygons" target="_blank">WDPA</a>, contains polygons of all the world's protected areas.
The third, <a href="https://developers.google.com/earth-engine/datasets/catalog/UCSB-CHG_CHIRPS_PENTAD" target="_blank">CHIRPS</a>, is a gridded rainfall time series dataset (Funk et al 2015) and the last,
<a href="https://developers.google.com/earth-engine/datasets/catalog/MODIS_006_MOD13Q1" target="_blank">MOD13Q1</a>, provides vegetation indexes (NDVI and EVI) depicting vegetation 'greenness' per 250m pixel.

<p><strong>Filtering data</strong>
<br>First define variables for the temporal window of interest, including a start-date, end-date and the range of years and months.
We will use these variables later to filter and summarise the long-term data.

<pre><p><code class="javascript" id="target2">var startDate0 = ee.Date.fromYMD(1981,1,1);
var startDate = ee.Date.fromYMD(2000,1,1);
var endDate = ee.Date.fromYMD(2019,12,31);
var years0 = ee.List.sequence(1981, 2019);
var years = ee.List.sequence(2000, 2019);
var months = ee.List.sequence(1, 12);</code><button class="btn" id="copy-button" data-clipboard-target="#target2">Copy</button>
<script>new ClipboardJS('.btn');</script></pre>

<p>Then filter our polygon features to our areas of interest (AOI), namely Costa Rica and Braulio Carrillo protected area.
At the same time, convert these two FeatureCollections to geometry objects as we'll need them later as function parameters for functions
we'll build.

<pre><p><code class="javascript" id="target3">// Country boundaries filtered to Costa Rica
var costaRica = Countries.filter(ee.Filter.inList('COUNTRY_NA', ['Costa Rica']));
// WDPA boundaries filtered to 'Braulio Carrillo' National Park in Costa Rica
var braulio = WDPA.filter(ee.Filter.stringContains('ORIG_NAME', 'Braulio Carrillo'));

// Convert features to geometry objects
var costaRica_geo = costaRica.geometry();
var braulio_geo = braulio.geometry();</code><button class="btn" id="copy-button" data-clipboard-target="#target3">Copy</button>
<script>new ClipboardJS('.btn');</script></pre>

<p>Now filter the CHIRPS <code>ImageCollection</code> for rainfall (i.e. <code>precipitation</code>) and the MODIS MOD13Q1 product for the Enhanced Vegetation Index (EVI)
instead of the Normalized Difference Vegetation Index (NDVI) used in the previous practical.
At the same time, filter by date range and our AOI to speed up all analyses that follow.

<pre><p><code class="javascript" id="target4">// Long-term rainfall data from CHIRPS
var rainAll = CHIRPS.select('precipitation')
    .filterDate(startDate, endDate)
    .filterBounds(costaRica_geo);
// print('Ã‡heck rainAll', rainAll);

// Long-term EVI data from MODIS
var eviAll = MOD13Q1.select('EVI')
    .filterDate(startDate, endDate)
    .filterBounds(costaRica_geo);</code><button class="btn" id="copy-button" data-clipboard-target="#target4">Copy</button>
<script>new ClipboardJS('.btn');</script></pre>

<p><strong>Processing</strong>
<br>To calculate the annual monthly sum of rainfall across Braulio Carrillo National Park from 1981 to 2019,
reduce the monthly rainfall records by their sum per year as follows:
<pre><p><code class="javascript" id="target5">var rainYr_list =  years.map(function(y){
var rain_year = rainAll.filter(ee.Filter.calendarRange(y, y, 'year')).sum().rename('rain_yr');
return rain_year.set('year', ee.Date.fromYMD(y,1,1));
});</code><button class="btn" id="copy-button" data-clipboard-target="#target5">Copy</button>
<script>new ClipboardJS('.btn');</script></pre>

<p>This produces a list of 20 images, which you'll need to convert back to an ImageCollection.
Then calculate the long-term annual rainfall patterns for Costa Rica as follows:
<pre><p><code class="javascript" id="target6">// Convert the image List to an ImageCollection.
var rainYr = ee.ImageCollection.fromImages(rainYr_list);
// Calculate long-term annual rainfall clipped to Costa Rica
var rainAnnual = rainYr.mean().clip(costaRica);</code><button class="btn" id="copy-button" data-clipboard-target="#target6">Copy</button>
<script>new ClipboardJS('.btn');</script></pre>


<p><strong>Visualisation</strong>
<br>Now let's plot these results on a map. First define the various map elements i.e. the title and symbology for the legend as follows:
<pre><p><code class="javascript" id="target7">var title = ui.Label('Costa Rica: Annual Rainfall 1981 to 2018', {
  stretch: 'horizontal',
  textAlign: 'center',
  fontWeight: 'bold',
  fontSize: '20px'});

var rainYvis = {
  min: 2100, max: 3800,
  palette: 'ffffff, 67d9f1, 1036cb'};</code><button class="btn" id="copy-button" data-clipboard-target="#target7">Copy</button>
<script>new ClipboardJS('.btn');</script></pre>

<p>Next, we centre the map to Costa Rica - In this way all other layers will align with this parent map.
Now add the long-term mean annual rainfall for Costa Rica and the Braulio Carrillo boundary. Lastly add the defined title.

<pre><p><code class="javascript" id="target8">Map.centerObject(costaRica, 8);
Map.addLayer(rainAnnual, rainYvis, 'Long-term Annual Rainfall');
Map.addLayer(braulio,{color: 'grey'}, 'Braulio Carrillo',true, 0.8);
Map.add(title);</code><button class="btn" id="copy-button" data-clipboard-target="#target8">Copy</button>
<script>new ClipboardJS('.btn');</script></pre>
<img src="img/4_img2.png" width="650" alt="" title="" />

<p><strong>Charting</strong>
<br>Now chart annual rainfall results but summarised for Braulio Carrillo National Park using a line chart.
To do this, first define the chart parameters (e.g. title and axis labels) and then create the line chart.

<pre><p><code class="javascript" id="target9">var opt_chart_annualPrecip = {
  title: 'Annual Rainfall: Braulio Carrillo National Park',
  pointSize: 2,
  hAxis: {title: 'Year'},
  vAxis: {title: 'Rainfall (mm)'},
};

var chart_annualPrecip = ui.Chart.image.series({
  imageCollection: rainYr,
  region:aoi_clip,
  reducer: ee.Reducer.mean(),
  scale: 5000,
  xProperty: 'year'
}).setOptions(opt_chart_annualPrecip);
// print(chart_annualPrecip);</code><button class="btn" id="copy-button" data-clipboard-target="#target9">Copy</button>
<script>new ClipboardJS('.btn');</script></pre>

<p>We could use <code>print()</code> to see the chart in the GEE console but for this practical we'll add the chart to our map layout instead.
To do this, first make a panel to hold the chart in the map, then add the empty panel to the map and fill it with your chart:

<pre><p><code class="javascript" id="target10">// Create a panel to hold the chart in the map
var panel = ui.Panel();
panel.style().set({
  width: '350px',
  position: 'bottom-left'
});
// Add empty panel to map
Map.add(panel);
// Add chart to panel
panel.add(chart_annualPrecip);</code><button class="btn" id="copy-button" data-clipboard-target="#target10">Copy</button>
<script>new ClipboardJS('.btn');</script></pre>
<img src="img/4_img3.png" width="650" alt="" title="" />

<p><strong>Save your map online</strong>
<br>Now for the fun part! We can share this map with the world by creating a GEE Application (App).
To save your map online as your first GEE App, follow the steps below:
<ol><li>Click the <code>Apps</code> button above
<li>Select <code>NEW APP</code>
<li>Give the App a Name and click <code>PUBLISH</code>. Leave everything else default
<li>Your new URL will appear - Click this to see your first online interactive map (if you get an error message, follow the steps below instead).
<li>If you see a <code>Not ready</code> page, give it a few minutes and try again</li></ol>
<img src="img/4_img4.png" width="650" alt="" title="" />

<p>If you get an error message, chances are you haven't accepted the terms and conditions of using GEE Apps in your Google Cloud Platform.
To do so, follow these steps instead of the ones above.
<ol><li>Click the Apps button above
<li>Select NEW APP
<li>Give the App a Name and click PUBLISH
<li>When the error appears, click the Cloud Terms of Service link
<li>This will open the Cloud Platform Console
<li>Go down to App Engine and select Dashboard
<li>You'll be asked to agree to the Terms of Service, AGREE AND CONTINUE
<li>Close your Cloud Platform Console and go back to GEE and click NEW APP again
<li>Give the App a Name and click PUBLISH. Leave everything else default
<li>Your new URL will appear - Click this to see your first online interactive map
<li>If you see a Not ready page, give it a few minutes or refresh the page and try again</li></ol>

<img src="img/4_img5.png" width="650" alt="" title="" />
<p><strong>And voilÃ ! Your first GEE App!</strong></p>
<img src="img/4_img6.png" width="650" alt="" title="" />

<p><strong>Relationship between annual rainfall and vegetation 'greenness'</strong>
<br>Taking things even further, we could also combine the calculation of annual max rainfall with annual maximum EVI for Costa Rica
for the same period, 2000 to 2019, to see whether there's a relationship between the two.
What do you think we'll see?

<pre><p><code class="javascript" id="target11">// Calculate annual mean for every year for both Rainfall and EVI imageCollections
var annualRainEVI_list =  years.map(function(y){
  var evi_year = eviAll.filter(ee.Filter.calendarRange(y, y, 'year'))
    .max().multiply(0.0001).rename('evi'); // Need to scale by constant
  var rain_year = rainAll.filter(ee.Filter.calendarRange(y, y, 'year'))
    .max().rename('rain');
  return rain_year.addBands(evi_year).set('year', ee.Date.fromYMD(y,1,1));
});</code><button class="btn" id="copy-button" data-clipboard-target="#target11">Copy</button>
<script>new ClipboardJS('.btn');</script></pre>

<p>Remember to convert the list that is returned, back to an ImageCollection, including a flatten() command as follows:
<pre><p><code class="javascript" id="target12">// Convert the image List to an ImageCollection.
var annualRainEVI = ee.ImageCollection.fromImages(annualRainEVI_list.flatten());</code><button class="btn" id="copy-button" data-clipboard-target="#target12">Copy</button>
<script>new ClipboardJS('.btn');</script></pre>

<p>Now plot both rainfall and EVI in a single chart. To create a comparative line chart of rainfall and EVI summaries for Braulio Carrillo,
first define the chart parameters and then create the line chart with two y-axes as follows:

<pre><p><code class="javascript" id="target13">// Display a comparative line chart of rainfall and EVI for Braulio Carrillo
// Set chart parameters e.g. title
var opt_annualRainEVI = {title: "Annual Max Rainfall vs. 'Greenness (EVI) for Braulio Carrillo", pointSize: 2,
    legend: {maxLines: 5, position: 'top'},
    series: { 0: {targetAxisIndex: 0},
              1: {targetAxisIndex: 1}},
        vAxes: {// Adds titles to each axis.
          0: {title: 'Max EVI (*0.0001)'},
          1: {title: 'Max Rainfall (mm)'}},};

// Build the chart and plot it
var rain_ndvi_chart = ui.Chart.image.series({
  imageCollection: annualRainEVI.select(['evi', 'rain']),
  region:aoi_clip,
  reducer: ee.Reducer.mean(),
  scale: 5000,
  xProperty: 'year'
}).setOptions(opt_annualRainEVI);
print(rain_ndvi_chart);</code><button class="btn" id="copy-button" data-clipboard-target="#target13">Copy</button>
<script>new ClipboardJS('.btn');</script></pre>

<img src="img/4_img7.png" width="500" alt="" title="" />
<p>We could also directly check the correlation between the two variables as follows:
<pre><p><code class="javascript" id="target14">// Compute a Pearson's product-moment correlation coefficient
// and the 2-sided p-value test for correlation = 0.
var opt_correl = {
	title: "Correlation between Rainfall and EVI for Braulio Carrillo", pointSize: 2,
    legend: {maxLines: 5, position: 'top'},
    series: { 0: {targetAxisIndex: 0},
              1: {targetAxisIndex: 1}},
        vAxes: {// Adds titles to each axis.
          0: {title: 'Correlation - R2)'},
          1: {title: 'P-Value'}},};
// Build the chart and plot it
var correl_chart = ui.Chart.image.series({
  imageCollection: annualRainEVI.select(['evi', 'rain']),
  region:aoi_clip,
  reducer: ee.Reducer.pearsonsCorrelation(),
  scale: 5000,
  xProperty: 'year'
}).setOptions(opt_correl);
print(correl_chart);</code><button class="btn" id="copy-button" data-clipboard-target="#target14">Copy</button>
<script>new ClipboardJS('.btn');</script></pre>
<img src="img/4_img8.png" width="500" alt="" title="" />
<p><strong>Data Export</strong>
<br>To export the data shown in the created charts, you can simply maximise the chart and then click Download to
export to formats .CSV, .SVG or .PNG.

<p><img src="img/4_img9.png" width="650" alt="" title="" />

<p>You can also script the export. This option will allow you to customise formats for your exported table.
For example, a formatted date field using a reducer to get the mean rainfall value for Braulio Carrillo for each year.
The exported csv table will then contain a column for both date and mean annual rainfall. Once the task is completed,
you will find this csv file in your google drive.

<pre><p><code class="javascript" id="target15">var csv_annualPrecip = rainYr.map(function(image){
  var year = image.get('year');
  var mean = image.reduceRegion({
    reducer: ee.Reducer.mean(),
    geometry: aoi_clip,
    scale: 5000
  });
  return ee.Feature(null, {'mean': mean.get('rain_yr'),'year': year})
});
// Export a .csv table of year and mean rainfall
Export.table.toDrive({
  collection: csv_annualPrecip,
  description: 'annualRain',
  folder: 'testOTS',
  fileFormat: 'CSV'
});</code><button class="btn" id="copy-button" data-clipboard-target="#target15">Copy</button>
<script>new ClipboardJS('.btn');</script></pre>

<p><strong>The last step, as always, is to save the script.</strong>

<p><strong>Practical 4 Exercise</strong>
<br>Repeat this practical but use NDVI instead of EVI and Germany instead of Costa Rica.
You can also play around with different dates, keeping in mind the different date limits for each ImageCollection.
To share your script, click on Get Link and then copy script path. Send your completed script to ots.online.education@gmail.com.
If you're feeling adventurous, save the results as a new App and forward the URL link along with your script.
Do you have any feedback for this practical? Please complete this quick (2-5 min) survey here.

<p><strong>References</strong>
<br>Funk C, Peterson P, Landsfeld M, Pedreros D, Verdin J, Shukla S, Husak G, Rowland J, Harrison L, Hoell A, Michaelsen J (2015)
The climate hazards infrared precipitation with stations-a new environmental record for monitoring extremes. Scientific Data 2, 150066
<br>
<br>MacFadyen S, Zambatis N, Van Teeffelen AJA, Hui C (2018) Long-term rainfall regression surfaces for the Kruger National Park,
South Africa: A spatio-temporal review of patterns from 1981-2015. International Journal of Climatology 38(5): 2506-2519

</div>

<div id="sidebar">
<h3>MENU</h3>
<ul>
<li><a href="../index.html">HOME</a></li>
<nav class="drop-down-menu">
<input type="checkbox" class="activate" id="accordion-1" name="accordion-1">
<label for="accordion-1" class="menu-title">> COURSE 2020</label>
<div class="drop-down">
<li><a href="">Check again later</a></li>
</div>
</nav>
<nav class="drop-down-menu">
<input type="checkbox" class="activate" id="accordion-2" name="accordion-2">
<label for="accordion-2" class="menu-title">> COURSE 2021</label>
<div class="drop-down">
<li><a href="1_prac.html">[Prac1] Getting started</a></li>
<li><a href="2_prac.html">[Prac2] Spectral indices</a></li>
<li><a href="3_prac.html">[Prac3] Time series-NDVI</a></li>
<li class="selected"><a href="4_prac.html">[Prac4] Interactive App</a></li>
<li><a href="5_prac.html">[Prac5] Time series-Fire</a></li>
<li><a href="6_prac.html">[Prac6] Change analysis</a></li>
<li><a href="7_prac.html">[Prac7] Landcover class</a></li>
<li><a href="8_prac.html">[Prac8] Species patterns</a></li>
<li><a href="9_prac.html">[Prac9] Your own data</a></li>
</div>
</nav>
<li><a href="10_contact.html">CONTACT US</a></li>
</nav>
</ul>

<h3></h3>
</div>

<div style="clear: both;"> </div>
<ul style="text-align:center; padding: 0px 0px 0px 0px;background: #ffffff;"><img src="img/logo_all.png" align="middle" width="800" height="123" alt="" title=""/></ul>

<div id="footer">
<p>&copy; Copyright 2021 BioGIS | Designed by <a href="http://www.biogis.co.za" target="_blank">BioGIS</a></p>
</div>

</div>
<!-- 2. Include library -->
<script src="../clipboard.min.js"></script>

<!-- 3. Instantiate clipboard -->
<script>
      var clipboard = new ClipboardJS('.btn');

      clipboard.on('success', function (e) {
        console.log(e);
      });

      clipboard.on('error', function (e) {
        console.log(e);
      });
</script>
</body>
</html>
